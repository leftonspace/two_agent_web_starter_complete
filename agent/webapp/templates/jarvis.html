<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jarvis - AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #34495e;
        }

        .sidebar-header {
            padding: 20px;
            background: #34495e;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h1 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-chat-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }

        .new-chat-btn:hover {
            background: #2980b9;
        }

        .conversations {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .conversation-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: #34495e;
        }

        .conversation-item.active {
            background: #3498db;
        }

        .conversation-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .conversation-preview {
            font-size: 12px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h2 {
            font-size: 18px;
            color: #2c3e50;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: #f0f0f0;
        }

        .icon-btn.active {
            background: #3498db;
            color: white;
        }

        /* Agents Dashboard Panel */
        .agents-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .agents-panel.open {
            right: 0;
        }

        .agents-panel-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .agents-panel-header h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-panel-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .close-panel-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .agents-summary {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .summary-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }

        .summary-stat .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .summary-stat .dot.active { background: #2ecc71; }
        .summary-stat .dot.idle { background: #3498db; }
        .summary-stat .dot.offline { background: #95a5a6; }
        .summary-stat .dot.error { background: #e74c3c; }
        .summary-stat .dot.waiting { background: #f39c12; }

        .agents-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .agent-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .agent-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .agent-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 600;
            font-size: 15px;
            color: #2c3e50;
        }

        .agent-type {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        .agent-status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .agent-status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .agent-status-badge.idle {
            background: #cce5ff;
            color: #004085;
        }

        .agent-status-badge.offline {
            background: #e2e3e5;
            color: #383d41;
        }

        .agent-status-badge.error {
            background: #f8d7da;
            color: #721c24;
        }

        .agent-status-badge.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .agent-description {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .agent-stats {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #95a5a6;
        }

        .agent-current-task {
            margin-top: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
            color: #2c3e50;
        }

        .agent-current-task .label {
            font-weight: 600;
            color: #7f8c8d;
        }

        /* Activity Feed */
        .activity-section {
            border-top: 1px solid #e0e0e0;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .activity-section h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .activity-item {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            color: #95a5a6;
            min-width: 50px;
        }

        .activity-agent {
            font-weight: 600;
            color: #2c3e50;
        }

        .activity-action {
            color: #7f8c8d;
        }

        /* Overlay */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }

        .panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Pulse animation for active status */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        .agent-card.is-active {
            border-color: #2ecc71;
            animation: pulse 2s infinite;
        }

        /* Image in Messages */
        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .message-image-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            margin-top: 10px;
        }

        .message-image-preview img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        /* Image Upload Preview */
        .upload-preview {
            display: none;
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            align-items: center;
            gap: 10px;
        }

        .upload-preview.active {
            display: flex;
        }

        .upload-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #3498db;
        }

        .upload-preview .info {
            flex: 1;
        }

        .upload-preview .filename {
            font-weight: 600;
            font-size: 14px;
        }

        .upload-preview .filesize {
            font-size: 12px;
            color: #7f8c8d;
        }

        .upload-preview .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* File Attachments Preview */
        .files-preview {
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #f0f4f8;
            border-top: 1px solid #e0e0e0;
            max-height: 120px;
            overflow-y: auto;
        }

        .attached-file {
            display: flex;
            align-items: center;
            gap: 6px;
            background: white;
            padding: 6px 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            font-size: 13px;
        }

        .attached-file .file-icon {
            font-size: 14px;
        }

        .attached-file .file-name {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .attached-file .file-size {
            color: #7f8c8d;
            font-size: 11px;
        }

        .attached-file .remove-file {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 14px;
            padding: 0 4px;
        }

        .attached-file .remove-file:hover {
            color: #c0392b;
        }

        /* Chat History Sidebar Improvements */
        .conversation-item {
            position: relative;
            padding-right: 40px;
        }

        .conversation-item .delete-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 14px;
        }

        .conversation-item:hover .delete-btn {
            opacity: 1;
        }

        .conversation-item .delete-btn:hover {
            color: #c0392b;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            left: 10px;
            top: 10px;
            z-index: 1000;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 999;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-toggle {
                display: block;
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 998;
            }

            .sidebar-overlay.visible {
                display: block;
            }
        }

        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .camera-modal.active {
            display: flex;
        }

        .camera-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 640px;
            width: 90%;
        }

        .camera-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .camera-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .camera-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .camera-video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        #camera-video {
            width: 100%;
            display: block;
        }

        #camera-canvas {
            display: none;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .camera-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-btn.capture {
            background: #3498db;
            color: white;
        }

        .camera-btn.switch {
            background: #f0f0f0;
        }

        .camera-btn:hover {
            opacity: 0.9;
        }

        .camera-permission-msg {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .camera-permission-msg button {
            margin-top: 15px;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Input area buttons */
        .input-actions {
            display: flex;
            gap: 5px;
        }

        .input-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .input-btn:hover {
            background: #f0f0f0;
        }

        .input-btn.listening {
            background: #e74c3c;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .input-btn.active {
            background: #3498db;
            color: white;
        }

        /* Hidden file input */
        #image-input {
            display: none;
        }

        /* Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #3498db;
        }

        .message.assistant .message-avatar {
            background: #9b59b6;
        }

        .message-content {
            flex: 1;
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            max-width: 80%;
        }

        .message.user .message-content {
            background: #3498db;
            color: white;
        }

        .message-content p {
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .message-metadata {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 8px;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 12px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #95a5a6;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* File List */
        .file-list {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }

        .file-item {
            padding: 6px;
            background: white;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        /* Task Progress */
        .task-progress {
            margin-top: 10px;
        }

        .task-step {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .task-step.complete {
            background: #d4edda;
            color: #155724;
        }

        .task-step.in-progress {
            background: #fff3cd;
            color: #856404;
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .attach-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .attach-btn:hover {
            background: #f0f0f0;
        }

        #message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            overflow-y: auto;
        }

        #message-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .send-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 24px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #2980b9;
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
        }

        .welcome-screen.hidden {
            display: none;
        }

        /* When welcome screen is hidden, messages take the space */
        .chat-main {
            display: flex;
            flex-direction: column;
        }

        .messages-container.active {
            flex: 1;
        }

        .welcome-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-screen p {
            font-size: 18px;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .example-prompt {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .example-prompt:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .example-prompt-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .example-prompt-text {
            font-size: 13px;
            color: #7f8c8d;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #bdc3c7;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle (Mobile) -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>ü§ñ Jarvis</h1>
                <button class="new-chat-btn" onclick="startNewChat()">‚ûï</button>
            </div>
            <div class="conversations" id="conversation-list">
                <!-- Conversations will be loaded here -->
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <div class="chat-header">
                <h2>Chat with Jarvis</h2>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleAgentsPanel()" title="AI Agents Dashboard" id="agents-btn">ü§ñ</button>
                    <button class="icon-btn" onclick="location.href='/dashboard'" title="Dashboard">üè†</button>
                    <button class="icon-btn" onclick="clearChat()" title="Clear chat">üóëÔ∏è</button>
                </div>
            </div>

            <!-- Welcome Screen (outside messages container so it doesn't get deleted) -->
            <div class="welcome-screen" id="welcome-screen">
                <h1>üëã Hello!</h1>
                <p>I'm Jarvis, your AI assistant. How can I help you today?</p>
                <div class="example-prompts">
                    <div class="example-prompt" onclick="sendExamplePrompt('Build me a simple website')">
                        <div class="example-prompt-title">üåê Build a Website</div>
                        <div class="example-prompt-text">Create a professional website</div>
                    </div>
                    <div class="example-prompt" onclick="sendExamplePrompt('Explain how async/await works in Python')">
                        <div class="example-prompt-title">üìö Learn Something</div>
                        <div class="example-prompt-text">Ask me to explain concepts</div>
                    </div>
                    <div class="example-prompt" onclick="sendExamplePrompt('Create a REST API with authentication')">
                        <div class="example-prompt-title">‚öôÔ∏è Build an API</div>
                        <div class="example-prompt-text">Full-stack development</div>
                    </div>
                    <div class="example-prompt" onclick="sendExamplePrompt('Help me debug my code')">
                        <div class="example-prompt-title">üêõ Debug Code</div>
                        <div class="example-prompt-text">Fix errors and improve code</div>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messages">
                <!-- Messages will be added here dynamically -->
            </div>

            <div class="typing-indicator" id="typing-indicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- Image Upload Preview -->
            <div class="upload-preview" id="upload-preview">
                <img id="preview-image" src="" alt="Preview">
                <div class="info">
                    <div class="filename" id="preview-filename">image.jpg</div>
                    <div class="filesize" id="preview-filesize">0 KB</div>
                </div>
                <button class="remove-btn" onclick="removeUploadedImage()">‚úï Remove</button>
            </div>

            <div class="input-area">
                <div class="input-actions">
                    <input type="file" id="image-input" accept="image/*" onchange="handleImageSelect(event)">
                    <button class="input-btn" onclick="document.getElementById('image-input').click()" title="Upload image">üñºÔ∏è</button>
                    <button class="input-btn" onclick="openCamera()" title="Camera">üì∑</button>
                    <button class="input-btn" onclick="attachFile()" title="Attach file">üìé</button>
                    <button class="input-btn" onclick="toggleVoiceInput()" title="Voice input" id="voice-btn">üé§</button>
                </div>
                <textarea id="message-input" placeholder="Message Jarvis..." rows="1" onkeydown="handleKeyPress(event)"></textarea>
                <button class="send-btn" onclick="sendMessage()" id="send-btn">Send ‚û§</button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div class="camera-modal" id="camera-modal">
        <div class="camera-container">
            <div class="camera-header">
                <h3>üì∑ Camera</h3>
                <button class="camera-close-btn" onclick="closeCamera()">‚úï</button>
            </div>
            <div class="camera-video-container">
                <video id="camera-video" autoplay playsinline></video>
                <canvas id="camera-canvas"></canvas>
                <div class="camera-permission-msg" id="camera-permission-msg" style="display: none;">
                    <p>JARVIS needs access to your camera to see what you're looking at.</p>
                    <button onclick="requestCameraPermission()">Allow Camera Access</button>
                </div>
            </div>
            <div class="camera-controls" id="camera-controls">
                <button class="camera-btn switch" onclick="switchCamera()" id="switch-camera-btn">üîÑ Switch</button>
                <button class="camera-btn capture" onclick="capturePhoto()">üì∏ Capture</button>
            </div>
        </div>
    </div>

    <!-- Overlay for panel -->
    <div class="panel-overlay" id="panel-overlay" onclick="closeAgentsPanel()"></div>

    <!-- AI Agents Dashboard Panel -->
    <div class="agents-panel" id="agents-panel">
        <div class="agents-panel-header">
            <h2>ü§ñ AI Agents</h2>
            <button class="close-panel-btn" onclick="closeAgentsPanel()">‚úï</button>
        </div>

        <div class="agents-summary" id="agents-summary">
            <div class="summary-stat">
                <span class="dot active"></span>
                <span id="summary-active">0</span> Active
            </div>
            <div class="summary-stat">
                <span class="dot idle"></span>
                <span id="summary-idle">0</span> Idle
            </div>
            <div class="summary-stat">
                <span class="dot offline"></span>
                <span id="summary-offline">0</span> Offline
            </div>
        </div>

        <div class="agents-list" id="agents-list">
            <!-- Agent cards will be loaded here -->
            <div style="text-align: center; padding: 40px; color: #95a5a6;">
                Loading agents...
            </div>
        </div>

        <div class="activity-section" id="activity-section">
            <h3>Recent Activity</h3>
            <div id="activity-list">
                <!-- Activity items will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let isProcessing = false;
        let currentChatId = null;
        let chatHistory = [];  // All saved chats
        let pendingFiles = [];  // Array of attached files (must be declared early)

        // ============================================================
        // Chat History Management (localStorage persistence)
        // ============================================================

        function loadChatHistory() {
            const stored = localStorage.getItem('jarvis_chat_history');
            chatHistory = stored ? JSON.parse(stored) : [];
            renderChatList();
        }

        function saveChatHistory() {
            localStorage.setItem('jarvis_chat_history', JSON.stringify(chatHistory));
        }

        function renderChatList() {
            const container = document.getElementById('conversation-list');
            if (chatHistory.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; opacity: 0.6;">No conversations yet</div>';
                return;
            }

            container.innerHTML = chatHistory.map((chat, index) => `
                <div class="conversation-item ${chat.id === currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                    <div class="conversation-title">${chat.title || 'New Chat'}</div>
                    <div class="conversation-preview">${chat.preview || 'Empty conversation'}</div>
                    <button class="delete-btn" onclick="event.stopPropagation(); deleteChat('${chat.id}')" title="Delete chat">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function createNewChatEntry() {
            currentChatId = 'chat_' + Date.now();
            const newChat = {
                id: currentChatId,
                title: 'New Chat',
                preview: '',
                messages: [],
                createdAt: Date.now(),
                updatedAt: Date.now()
            };
            chatHistory.unshift(newChat);
            saveChatHistory();
            renderChatList();
            return newChat;
        }

        function updateCurrentChat(messages, title = null) {
            const chat = chatHistory.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages = messages;
                chat.updatedAt = Date.now();
                if (title) chat.title = title;
                // Update preview from last user message
                const lastUserMsg = messages.filter(m => m.role === 'user').pop();
                if (lastUserMsg) {
                    chat.preview = lastUserMsg.content.substring(0, 50) + (lastUserMsg.content.length > 50 ? '...' : '');
                    if (!title) {
                        chat.title = lastUserMsg.content.substring(0, 30) + (lastUserMsg.content.length > 30 ? '...' : '');
                    }
                }
                saveChatHistory();
                renderChatList();
            }
        }

        function loadChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            renderChatList();

            // Clear current messages
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';

            // Show/hide welcome screen based on whether chat has messages
            if (chat.messages.length > 0) {
                hideWelcomeScreen();
            } else {
                showWelcomeScreen();
            }

            // Render saved messages
            chat.messages.forEach(msg => {
                addMessage(msg.role, msg.content, msg.metadata || {}, false);
            });

            closeSidebar();
        }

        function deleteChat(chatId) {
            if (!confirm('Delete this conversation?')) return;

            chatHistory = chatHistory.filter(c => c.id !== chatId);
            saveChatHistory();

            if (chatId === currentChatId) {
                startNewChat();
            } else {
                renderChatList();
            }
        }

        // ============================================================
        // Sidebar Toggle (Mobile)
        // ============================================================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('visible');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('visible');
        }

        // ============================================================
        // Session Management
        // ============================================================

        // Initialize session
        async function initSession() {
            try {
                const response = await fetch('/api/chat/session/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'user_' + Date.now() })
                });

                const data = await response.json();
                sessionId = data.session_id;
                console.log('Session started:', sessionId);
            } catch (error) {
                console.error('Failed to start session:', error);
            }
        }

        // Send message - placeholder, gets overwritten by unified version below
        async function sendMessage() {
            // This function is defined properly later in the file
            // with full support for text, images, and file attachments
            console.log('sendMessage placeholder called');
        }

        // Add message to chat
        function addMessage(role, content, metadata = {}, saveToHistory = true) {
            const messagesContainer = document.getElementById('messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const text = document.createElement('p');
            text.textContent = content;
            contentDiv.appendChild(text);

            // Add attached files display if present
            if (metadata.attached_files && metadata.attached_files.length > 0) {
                const fileList = document.createElement('div');
                fileList.className = 'file-list';
                fileList.innerHTML = '<strong>Attached files:</strong>';
                metadata.attached_files.forEach(f => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.textContent = `üìÑ ${f}`;
                    fileList.appendChild(fileItem);
                });
                contentDiv.appendChild(fileList);
            }

            // Add file list if present
            if (metadata.files_created && metadata.files_created.length > 0) {
                const fileList = document.createElement('div');
                fileList.className = 'file-list';
                metadata.files_created.slice(0, 5).forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.textContent = `üìÑ ${file}`;
                    fileList.appendChild(fileItem);
                });
                contentDiv.appendChild(fileList);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Save to chat history
            if (saveToHistory && currentChatId) {
                const chat = chatHistory.find(c => c.id === currentChatId);
                if (chat) {
                    chat.messages.push({ role, content, metadata, timestamp: Date.now() });
                    updateCurrentChat(chat.messages);
                }
            }
        }

        // Show/hide typing indicator
        function showTyping() {
            document.getElementById('typing-indicator').classList.add('active');
        }

        function hideTyping() {
            document.getElementById('typing-indicator').classList.remove('active');
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Send example prompt
        function sendExamplePrompt(prompt) {
            document.getElementById('message-input').value = prompt;
            sendMessage();
        }

        // Start new chat
        function startNewChat() {
            document.getElementById('messages').innerHTML = '';
            showWelcomeScreen();
            createNewChatEntry();
            initSession();
            closeSidebar();
        }

        // Helper functions to show/hide welcome screen
        function showWelcomeScreen() {
            const welcome = document.getElementById('welcome-screen');
            const messages = document.getElementById('messages');
            welcome.classList.remove('hidden');
            messages.classList.remove('active');
        }

        function hideWelcomeScreen() {
            const welcome = document.getElementById('welcome-screen');
            const messages = document.getElementById('messages');
            welcome.classList.add('hidden');
            messages.classList.add('active');
        }

        // Clear chat
        function clearChat() {
            if (confirm('Clear this conversation?')) {
                startNewChat();
            }
        }

        // Attach file - real implementation
        function attachFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.txt,.md,.py,.js,.ts,.html,.css,.json,.yaml,.yml,.xml,.csv,.log,.sh,.bat,.sql,.java,.c,.cpp,.h,.go,.rs,.rb,.php';

            input.onchange = async (event) => {
                const files = Array.from(event.target.files);
                for (const file of files) {
                    await addAttachedFile(file);
                }
            };
            input.click();
        }

        async function addAttachedFile(file) {
            // Check file size (max 1MB for text files)
            if (file.size > 1024 * 1024) {
                alert(`File "${file.name}" is too large. Maximum size is 1MB.`);
                return;
            }

            try {
                const content = await file.text();
                pendingFiles.push({
                    name: file.name,
                    content: content,
                    size: file.size,
                    type: file.type || 'text/plain'
                });
                showAttachedFiles();
            } catch (error) {
                alert(`Could not read file "${file.name}". Only text files are supported.`);
            }
        }

        function showAttachedFiles() {
            let preview = document.getElementById('files-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'files-preview';
                preview.className = 'files-preview';
                document.querySelector('.input-area').insertBefore(preview, document.getElementById('message-input'));
            }

            if (pendingFiles.length === 0) {
                preview.style.display = 'none';
                return;
            }

            preview.style.display = 'flex';
            preview.innerHTML = pendingFiles.map((f, i) => `
                <div class="attached-file">
                    <span class="file-icon">üìÑ</span>
                    <span class="file-name">${f.name}</span>
                    <span class="file-size">(${formatFileSize(f.size)})</span>
                    <button class="remove-file" onclick="removeAttachedFile(${i})">‚úï</button>
                </div>
            `).join('');
        }

        function removeAttachedFile(index) {
            pendingFiles.splice(index, 1);
            showAttachedFiles();
        }

        function clearAttachedFiles() {
            pendingFiles = [];
            showAttachedFiles();
        }

        // Auto-resize textarea
        document.getElementById('message-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Initialize on load
        window.addEventListener('load', () => {
            loadChatHistory();
            // Start new chat if none exists
            if (chatHistory.length === 0) {
                createNewChatEntry();
                showWelcomeScreen();
            } else {
                // Load most recent chat
                loadChat(chatHistory[0].id);
            }
            initSession();
            loadAgentsStatus();
        });

        // ============================================================
        // AI Agents Dashboard Functions
        // ============================================================

        let agentsWebSocket = null;
        let agentsPanelOpen = false;

        // Toggle agents panel
        function toggleAgentsPanel() {
            if (agentsPanelOpen) {
                closeAgentsPanel();
            } else {
                openAgentsPanel();
            }
        }

        // Open agents panel
        function openAgentsPanel() {
            document.getElementById('agents-panel').classList.add('open');
            document.getElementById('panel-overlay').classList.add('visible');
            document.getElementById('agents-btn').classList.add('active');
            agentsPanelOpen = true;

            // Load fresh data
            loadAgentsStatus();
            loadAgentActivity();

            // Connect WebSocket for real-time updates
            connectAgentsWebSocket();
        }

        // Close agents panel
        function closeAgentsPanel() {
            document.getElementById('agents-panel').classList.remove('open');
            document.getElementById('panel-overlay').classList.remove('visible');
            document.getElementById('agents-btn').classList.remove('active');
            agentsPanelOpen = false;

            // Disconnect WebSocket
            if (agentsWebSocket) {
                agentsWebSocket.close();
                agentsWebSocket = null;
            }
        }

        // Load agents status
        async function loadAgentsStatus() {
            try {
                const response = await fetch('/api/agents/status');
                const data = await response.json();

                renderAgentsList(data.agents);
                updateSummary(data.summary);
            } catch (error) {
                console.error('Failed to load agents:', error);
                document.getElementById('agents-list').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        Failed to load agents. Is the API running?
                    </div>
                `;
            }
        }

        // Load agent activity
        async function loadAgentActivity() {
            try {
                const response = await fetch('/api/agents/activity?limit=10');
                const data = await response.json();

                renderActivityList(data.activities);
            } catch (error) {
                console.error('Failed to load activity:', error);
            }
        }

        // Render agents list
        function renderAgentsList(agents) {
            const container = document.getElementById('agents-list');

            if (!agents || agents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #95a5a6;">
                        No agents registered
                    </div>
                `;
                return;
            }

            // Sort: active first, then idle, then offline
            const statusOrder = { 'active': 0, 'waiting': 1, 'idle': 2, 'error': 3, 'offline': 4 };
            agents.sort((a, b) => (statusOrder[a.status] || 5) - (statusOrder[b.status] || 5));

            container.innerHTML = agents.map(agent => `
                <div class="agent-card ${agent.status === 'active' ? 'is-active' : ''}" data-agent-id="${agent.id}">
                    <div class="agent-card-header">
                        <div class="agent-avatar" style="background-color: ${agent.color}20;">
                            ${agent.avatar}
                        </div>
                        <div class="agent-info">
                            <div class="agent-name">${agent.name}</div>
                            <div class="agent-type">${agent.type}</div>
                        </div>
                        <span class="agent-status-badge ${agent.status}">${agent.status}</span>
                    </div>
                    <div class="agent-description">${agent.description}</div>
                    <div class="agent-stats">
                        <span>Tasks: ${agent.tasks_completed}</span>
                        ${agent.last_activity ? `<span>Last active: ${formatTimeAgo(agent.last_activity)}</span>` : ''}
                    </div>
                    ${agent.current_task ? `
                        <div class="agent-current-task">
                            <span class="label">Working on:</span> ${agent.current_task}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Update summary counts
        function updateSummary(summary) {
            document.getElementById('summary-active').textContent = summary.active || 0;
            document.getElementById('summary-idle').textContent = summary.idle || 0;
            document.getElementById('summary-offline').textContent = summary.offline || 0;
        }

        // Render activity list
        function renderActivityList(activities) {
            const container = document.getElementById('activity-list');

            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #95a5a6; font-size: 12px;">
                        No recent activity
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <span class="activity-time">${formatTimeAgo(activity.timestamp)}</span>
                    <span class="activity-agent">${activity.agent_name}</span>
                    <span class="activity-action">${activity.action}</span>
                </div>
            `).join('');
        }

        // Format time ago
        function formatTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        // Connect WebSocket for real-time updates
        function connectAgentsWebSocket() {
            if (agentsWebSocket) return;

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/api/agents/stream`;

            try {
                agentsWebSocket = new WebSocket(wsUrl);

                agentsWebSocket.onopen = () => {
                    console.log('Agents WebSocket connected');
                };

                agentsWebSocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    if (data.type === 'initial') {
                        renderAgentsList(data.agents);
                        updateSummary(data.summary);
                    } else if (data.type === 'agent_update') {
                        updateAgentCard(data.agent);
                        loadAgentsStatus(); // Refresh full list
                    } else if (data.type === 'heartbeat') {
                        // Keep-alive, no action needed
                    }
                };

                agentsWebSocket.onclose = () => {
                    console.log('Agents WebSocket disconnected');
                    agentsWebSocket = null;
                };

                agentsWebSocket.onerror = (error) => {
                    console.error('Agents WebSocket error:', error);
                };
            } catch (error) {
                console.error('Failed to connect WebSocket:', error);
            }
        }

        // Update single agent card
        function updateAgentCard(agent) {
            const card = document.querySelector(`[data-agent-id="${agent.id}"]`);
            if (card) {
                // Update status badge
                const badge = card.querySelector('.agent-status-badge');
                if (badge) {
                    badge.className = `agent-status-badge ${agent.status}`;
                    badge.textContent = agent.status;
                }

                // Update active animation
                if (agent.status === 'active') {
                    card.classList.add('is-active');
                } else {
                    card.classList.remove('is-active');
                }

                // Flash card to show update
                card.style.transform = 'scale(1.02)';
                setTimeout(() => {
                    card.style.transform = '';
                }, 200);
            }
        }

        // Keyboard shortcut: Escape to close panel
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && agentsPanelOpen) {
                closeAgentsPanel();
            }
            if (e.key === 'Escape' && cameraActive) {
                closeCamera();
            }
        });

        // ============================================================
        // Image Upload and Camera Functions
        // ============================================================

        let pendingImage = null;  // { base64, filename, size }
        let cameraStream = null;
        let cameraActive = false;
        let facingMode = 'user';  // 'user' (front) or 'environment' (back)

        // Handle image file selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('Image too large. Maximum size is 10MB.');
                return;
            }

            // Read and preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result.split(',')[1];
                pendingImage = {
                    base64: base64,
                    filename: file.name,
                    size: file.size,
                    dataUrl: e.target.result
                };

                // Show preview
                showUploadPreview(pendingImage);
            };
            reader.readAsDataURL(file);
        }

        // Show upload preview
        function showUploadPreview(image) {
            document.getElementById('preview-image').src = image.dataUrl;
            document.getElementById('preview-filename').textContent = image.filename;
            document.getElementById('preview-filesize').textContent = formatFileSize(image.size);
            document.getElementById('upload-preview').classList.add('active');
        }

        // Remove uploaded image
        function removeUploadedImage() {
            pendingImage = null;
            document.getElementById('upload-preview').classList.remove('active');
            document.getElementById('image-input').value = '';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Unified sendMessage - handles text, images, AND file attachments
        // This overwrites the basic sendMessage defined earlier
        sendMessage = async function() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();

            // Need either message, image, or files
            if (!message && !pendingImage && pendingFiles.length === 0) return;
            if (isProcessing) return;

            // Hide welcome screen and show messages
            hideWelcomeScreen();

            // Prepare context with attached files
            const context = {};
            const userMetadata = {};

            // Add file attachments to context
            if (pendingFiles.length > 0) {
                context.attached_files = pendingFiles.map(f => ({
                    name: f.name,
                    content: f.content,
                    type: f.type
                }));
                userMetadata.attached_files = pendingFiles.map(f => f.name);
            }

            // Determine display message
            let displayMessage = message;
            if (!message && pendingImage) {
                displayMessage = 'What do you see in this image?';
            } else if (!message && pendingFiles.length > 0) {
                displayMessage = `Analyze these ${pendingFiles.length} file(s)`;
            }

            // Add user message (with image if present)
            if (pendingImage) {
                addMessageWithImage('user', displayMessage, pendingImage);
            } else {
                addMessage('user', displayMessage, userMetadata);
            }

            // Clear inputs
            input.value = '';
            input.style.height = 'auto';
            const imageToSend = pendingImage;
            const filesToSend = [...pendingFiles];
            removeUploadedImage();
            clearAttachedFiles();

            // Show typing indicator
            showTyping();
            isProcessing = true;
            document.getElementById('send-btn').disabled = true;

            try {
                let response;
                let data;

                if (imageToSend) {
                    // Send to vision API
                    response = await fetch('/api/vision/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: displayMessage,
                            image_base64: imageToSend.base64,
                            context: context
                        })
                    });
                    data = await response.json();
                } else {
                    // Send to regular chat API with file context
                    const requestMessage = filesToSend.length > 0 && !message
                        ? `Please analyze these files: ${filesToSend.map(f => f.name).join(', ')}`
                        : message;

                    response = await fetch('/api/chat/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: requestMessage,
                            context: context
                        })
                    });
                    data = await response.json();
                }

                // Hide typing indicator
                hideTyping();

                // Add assistant response
                addMessage('assistant', data.content, data.metadata || {});

            } catch (error) {
                hideTyping();
                addMessage('assistant', `I'm afraid I encountered an error: ${error.message}`, { error: true });
            } finally {
                isProcessing = false;
                document.getElementById('send-btn').disabled = false;
            }
        };

        // Add message with image
        function addMessageWithImage(role, content, image = null, saveToHistory = true) {
            const messages = document.getElementById('messages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Add text
            if (content) {
                const text = document.createElement('p');
                text.textContent = content;
                contentDiv.appendChild(text);
            }

            // Add image if present
            if (image) {
                const img = document.createElement('img');
                img.className = 'message-image';
                img.src = image.dataUrl;
                img.alt = 'Uploaded image';
                img.onclick = () => window.open(image.dataUrl, '_blank');
                contentDiv.appendChild(img);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messages.appendChild(messageDiv);

            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;

            // Save to chat history (note: image dataUrl is NOT saved to avoid localStorage bloat)
            if (saveToHistory && currentChatId) {
                const chat = chatHistory.find(c => c.id === currentChatId);
                if (chat) {
                    const metadata = image ? { hasImage: true, imageName: image.filename } : {};
                    chat.messages.push({ role, content, metadata, timestamp: Date.now() });
                    updateCurrentChat(chat.messages);
                }
            }
        }

        // ============================================================
        // Camera Functions
        // ============================================================

        // Open camera modal
        async function openCamera() {
            document.getElementById('camera-modal').classList.add('active');
            cameraActive = true;

            // Check if camera API is available
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showCameraPermissionMessage('Camera not supported in this browser.');
                return;
            }

            await requestCameraPermission();
        }

        // Request camera permission and start stream
        async function requestCameraPermission() {
            try {
                // Hide permission message
                document.getElementById('camera-permission-msg').style.display = 'none';

                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);

                const video = document.getElementById('camera-video');
                video.srcObject = cameraStream;
                video.style.display = 'block';

                // Show/hide switch button on mobile (has multiple cameras)
                const hasMultipleCameras = await checkMultipleCameras();
                document.getElementById('switch-camera-btn').style.display = hasMultipleCameras ? 'flex' : 'none';

            } catch (error) {
                console.error('Camera error:', error);

                if (error.name === 'NotAllowedError') {
                    showCameraPermissionMessage('Camera access denied. Please allow camera access to use this feature.');
                } else if (error.name === 'NotFoundError') {
                    showCameraPermissionMessage('No camera found on this device.');
                } else {
                    showCameraPermissionMessage(`Camera error: ${error.message}`);
                }
            }
        }

        // Check if device has multiple cameras
        async function checkMultipleCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(d => d.kind === 'videoinput');
                return cameras.length > 1;
            } catch {
                return false;
            }
        }

        // Show permission/error message
        function showCameraPermissionMessage(message) {
            const msgDiv = document.getElementById('camera-permission-msg');
            msgDiv.querySelector('p').textContent = message;
            msgDiv.style.display = 'block';
            document.getElementById('camera-video').style.display = 'none';
        }

        // Switch between front and back camera
        async function switchCamera() {
            facingMode = facingMode === 'user' ? 'environment' : 'user';

            // Stop current stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }

            // Start new stream
            await requestCameraPermission();
        }

        // Capture photo from camera
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');

            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Get image data
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            const base64 = dataUrl.split(',')[1];

            // Set as pending image
            pendingImage = {
                base64: base64,
                filename: 'camera_capture.jpg',
                size: Math.round(base64.length * 0.75),  // Approximate size
                dataUrl: dataUrl
            };

            // Show preview and close camera
            showUploadPreview(pendingImage);
            closeCamera();
        }

        // Close camera modal
        function closeCamera() {
            document.getElementById('camera-modal').classList.remove('active');
            cameraActive = false;

            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const video = document.getElementById('camera-video');
            video.srcObject = null;
        }

        // Close camera modal when clicking outside
        document.getElementById('camera-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCamera();
            }
        });

        // Ensure camera is stopped when page unloads
        window.addEventListener('beforeunload', () => {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });

        // ============================================================
        // Voice Input Functions
        // ============================================================

        let voiceRecognition = null;
        let isListening = false;

        function toggleVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice input is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            if (isListening) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        }

        function startVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceRecognition = new SpeechRecognition();
            voiceRecognition.continuous = false;
            voiceRecognition.interimResults = true;
            voiceRecognition.lang = 'en-US';

            voiceRecognition.onstart = () => {
                isListening = true;
                document.getElementById('voice-btn').classList.add('listening');
                document.getElementById('voice-btn').textContent = 'üî¥';
                document.getElementById('message-input').placeholder = 'Listening...';
            };

            voiceRecognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const input = document.getElementById('message-input');
                if (finalTranscript) {
                    input.value = finalTranscript;
                } else if (interimTranscript) {
                    input.value = interimTranscript;
                }
            };

            voiceRecognition.onerror = (event) => {
                console.error('Voice recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access to use voice input.');
                }
                stopVoiceInput();
            };

            voiceRecognition.onend = () => {
                stopVoiceInput();
                // Auto-send if we got a result
                const input = document.getElementById('message-input');
                if (input.value.trim()) {
                    // Give user a moment to see what was transcribed
                    setTimeout(() => {
                        if (confirm('Send this message?\n\n"' + input.value + '"')) {
                            sendMessage();
                        }
                    }, 500);
                }
            };

            voiceRecognition.start();
        }

        function stopVoiceInput() {
            if (voiceRecognition) {
                voiceRecognition.stop();
                voiceRecognition = null;
            }
            isListening = false;
            document.getElementById('voice-btn').classList.remove('listening');
            document.getElementById('voice-btn').textContent = 'üé§';
            document.getElementById('message-input').placeholder = 'Message Jarvis...';
        }
    </script>
</body>
</html>
