{% extends "base.html" %}

{% block title %}{{ project_id }} - Projects - AI Dev Team Dashboard{% endblock %}

{% block extra_head %}
<style>
.layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.file-tree {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    max-height: 800px;
    overflow-y: auto;
}

.file-tree-item {
    padding: 6px 8px;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
    user-select: none;
    display: flex;
    align-items: center;
    gap: 6px;
}

.file-tree-item:hover {
    background: #f7fafc;
}

.file-tree-item.active {
    background: #e6f2ff;
    color: #667eea;
    font-weight: 500;
}

.file-tree-item .icon {
    width: 16px;
    flex-shrink: 0;
}

.file-tree-item .name {
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.file-tree-children {
    margin-left: 20px;
    display: none;
}

.file-tree-children.expanded {
    display: block;
}

.file-viewer {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.file-viewer pre {
    background: #2d3748;
    color: #e2e8f0;
    padding: 20px;
    border-radius: 6px;
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
    font-size: 0.85rem;
    line-height: 1.5;
}

.tabs {
    display: flex;
    gap: 10px;
    border-bottom: 2px solid #e2e8f0;
    margin-bottom: 20px;
}

.tab {
    padding: 10px 20px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
    color: #718096;
}

.tab:hover {
    color: #2d3748;
}

.tab.active {
    color: #667eea;
    border-bottom-color: #667eea;
    font-weight: 600;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.snapshot-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.snapshot-item {
    padding: 15px;
    background: #f7fafc;
    border-radius: 6px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
}

.snapshot-item:hover {
    border-color: #cbd5e0;
}

.snapshot-item.selected {
    border-color: #667eea;
    background: #e6f2ff;
}

.diff-controls {
    display: flex;
    gap: 15px;
    align-items: end;
    margin-bottom: 20px;
    padding: 15px;
    background: #f7fafc;
    border-radius: 6px;
}

.diff-viewer pre {
    background: #2d3748;
    color: #e2e8f0;
    padding: 20px;
    border-radius: 6px;
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
    font-size: 0.85rem;
    line-height: 1.5;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Courier New', monospace;
}

.diff-line-added {
    background: rgba(72, 187, 120, 0.2);
    color: #68d391;
}

.diff-line-removed {
    background: rgba(245, 101, 101, 0.2);
    color: #fc8181;
}

.breadcrumb {
    font-size: 0.9rem;
    color: #718096;
    margin-bottom: 15px;
}

.breadcrumb a {
    color: #667eea;
}
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/projects">‚Üê Projects</a> / {{ project_id }}
</div>

<h1 style="font-size: 1.75rem; color: #2d3748; margin-bottom: 20px;">üìÅ {{ project_id }}</h1>

<div class="tabs">
    <div class="tab active" onclick="switchTab('explorer')">üóÇÔ∏è File Explorer</div>
    <div class="tab" onclick="switchTab('snapshots')">üì∏ Snapshots ({{ snapshots|length }})</div>
    <div class="tab" onclick="switchTab('diff')">üîÑ Compare</div>
</div>

<!-- File Explorer Tab -->
<div id="tab-explorer" class="tab-content active">
    <div class="layout">
        <div class="file-tree">
            <h3 style="margin-bottom: 15px; color: #2d3748;">Files</h3>
            <div id="file-tree-root"></div>
        </div>
        <div class="file-viewer">
            <div id="file-viewer-content">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p>Select a file from the tree to view its contents</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Snapshots Tab -->
<div id="tab-snapshots" class="tab-content">
    <div class="card">
        <h2>Iteration Snapshots</h2>
        {% if snapshots %}
        <p style="color: #718096; margin-bottom: 20px;">
            This project has {{ snapshots|length }} snapshot{{ 's' if snapshots|length != 1 else '' }}.
            Click on a snapshot to browse its files.
        </p>
        <div class="snapshot-list">
            {% for snapshot in snapshots %}
            <div class="snapshot-item" onclick="viewSnapshot('{{ snapshot.id }}')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #2d3748;">{{ snapshot.id }}</strong>
                        <span style="margin-left: 10px; font-size: 0.85rem; color: #718096;">Iteration {{ snapshot.iteration }}</span>
                    </div>
                    <button onclick="event.stopPropagation(); viewSnapshot('{{ snapshot.id }}')"
                            style="padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                        Browse Files
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p>No snapshots available for this project yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Diff/Compare Tab -->
<div id="tab-diff" class="tab-content">
    <div class="card">
        <h2>Compare Versions</h2>
        <p style="color: #718096; margin-bottom: 20px;">
            Compare files between different iterations or with the current version.
        </p>

        <div class="diff-controls">
            <div style="flex: 1;">
                <label style="font-size: 0.9rem; color: #4a5568; margin-bottom: 5px;">Source Version</label>
                <select id="diff-source" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                    <option value="current">Current Version</option>
                    {% for snapshot in snapshots %}
                    <option value="{{ snapshot.id }}">{{ snapshot.id }} (Iteration {{ snapshot.iteration }})</option>
                    {% endfor %}
                </select>
            </div>
            <div style="flex: 1;">
                <label style="font-size: 0.9rem; color: #4a5568; margin-bottom: 5px;">Target Version</label>
                <select id="diff-target" style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
                    <option value="current">Current Version</option>
                    {% for snapshot in snapshots %}
                    <option value="{{ snapshot.id }}">{{ snapshot.id }} (Iteration {{ snapshot.iteration }})</option>
                    {% endfor %}
                </select>
            </div>
            <div style="flex: 1;">
                <label style="font-size: 0.9rem; color: #4a5568; margin-bottom: 5px;">File Path</label>
                <input type="text" id="diff-file-path" placeholder="e.g., index.html"
                       style="width: 100%; padding: 8px; border: 1px solid #cbd5e0; border-radius: 4px;">
            </div>
            <button onclick="computeDiff()"
                    style="padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Compare
            </button>
        </div>

        <div id="diff-result"></div>
    </div>
</div>

<script>
const PROJECT_ID = '{{ project_id }}';
let currentView = 'current';  // 'current' or snapshot_id
let currentFile = null;

// Tab switching
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
}

// Load and display file tree
async function loadFileTree(snapshotId = null) {
    const url = snapshotId
        ? `/api/projects/${PROJECT_ID}/snapshots/${snapshotId}/tree`
        : `/api/projects/${PROJECT_ID}/tree`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load file tree');

        const tree = await response.json();
        displayFileTree(tree, document.getElementById('file-tree-root'), snapshotId);
        currentView = snapshotId || 'current';
    } catch (error) {
        console.error('Error loading file tree:', error);
        document.getElementById('file-tree-root').innerHTML =
            '<p style="color: #e53e3e;">Error loading file tree</p>';
    }
}

// Display file tree recursively
function displayFileTree(nodes, container, snapshotId = null) {
    container.innerHTML = '';

    nodes.forEach(node => {
        const item = document.createElement('div');

        if (node.is_dir) {
            item.className = 'file-tree-item';
            item.innerHTML = `
                <span class="icon">üìÅ</span>
                <span class="name">${node.name}</span>
            `;
            item.onclick = (e) => {
                e.stopPropagation();
                toggleDirectory(item, node.path, snapshotId);
            };
        } else {
            item.className = 'file-tree-item';
            item.innerHTML = `
                <span class="icon">üìÑ</span>
                <span class="name">${node.name}</span>
            `;
            item.onclick = (e) => {
                e.stopPropagation();
                loadFile(node.path, snapshotId);
                document.querySelectorAll('.file-tree-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            };
        }

        container.appendChild(item);
    });
}

// Toggle directory expand/collapse
async function toggleDirectory(item, path, snapshotId = null) {
    const childrenContainer = item.nextElementSibling;

    if (childrenContainer && childrenContainer.classList.contains('file-tree-children')) {
        // Toggle existing children
        childrenContainer.classList.toggle('expanded');
        item.querySelector('.icon').textContent =
            childrenContainer.classList.contains('expanded') ? 'üìÇ' : 'üìÅ';
    } else {
        // Load and display children
        const url = snapshotId
            ? `/api/projects/${PROJECT_ID}/snapshots/${snapshotId}/tree?path=${encodeURIComponent(path)}`
            : `/api/projects/${PROJECT_ID}/tree?path=${encodeURIComponent(path)}`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load directory');

            const children = await response.json();
            const childrenDiv = document.createElement('div');
            childrenDiv.className = 'file-tree-children expanded';
            displayFileTree(children, childrenDiv, snapshotId);
            item.after(childrenDiv);
            item.querySelector('.icon').textContent = 'üìÇ';
        } catch (error) {
            console.error('Error loading directory:', error);
        }
    }
}

// Load and display file content
async function loadFile(path, snapshotId = null) {
    const url = snapshotId
        ? `/api/projects/${PROJECT_ID}/snapshots/${snapshotId}/file?path=${encodeURIComponent(path)}`
        : `/api/projects/${PROJECT_ID}/file?path=${encodeURIComponent(path)}`;

    const viewer = document.getElementById('file-viewer-content');
    viewer.innerHTML = '<p>Loading...</p>';

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to load file');

        const result = await response.json();

        if (result.error) {
            viewer.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
        } else {
            const viewSource = snapshotId ? snapshotId : 'current';
            viewer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #2d3748;">${path}</h3>
                    <span style="font-size: 0.85rem; color: #718096;">Source: ${viewSource}</span>
                </div>
                <pre>${escapeHtml(result.content)}</pre>
            `;
            currentFile = path;
        }
    } catch (error) {
        console.error('Error loading file:', error);
        viewer.innerHTML = '<div class="alert alert-error">Error loading file</div>';
    }
}

// View snapshot files
function viewSnapshot(snapshotId) {
    switchTab('explorer');
    loadFileTree(snapshotId);
}

// Compute and display diff
async function computeDiff() {
    const source = document.getElementById('diff-source').value;
    const target = document.getElementById('diff-target').value;
    const filePath = document.getElementById('diff-file-path').value.trim();

    if (!filePath) {
        alert('Please enter a file path');
        return;
    }

    const sourceType = source === 'current' ? 'current' : 'snapshot';
    const sourceId = source === 'current' ? null : source;
    const targetType = target === 'current' ? 'current' : 'snapshot';
    const targetId = target === 'current' ? null : target;

    const params = new URLSearchParams({
        project_id: PROJECT_ID,
        file_path: filePath,
        source_type: sourceType,
        target_type: targetType,
    });

    if (sourceId) params.append('source_id', sourceId);
    if (targetId) params.append('target_id', targetId);

    const resultDiv = document.getElementById('diff-result');
    resultDiv.innerHTML = '<p>Computing diff...</p>';

    try {
        const response = await fetch(`/api/diff?${params}`);
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to compute diff');
        }

        const result = await response.json();

        if (result.error) {
            resultDiv.innerHTML = `<div class="alert alert-error">${result.error}</div>`;
        } else if (result.is_binary) {
            resultDiv.innerHTML = `<div class="alert alert-info">Binary files cannot be compared</div>`;
        } else {
            // Format diff with syntax highlighting
            const diffHtml = formatDiff(result.diff);
            resultDiv.innerHTML = `
                <h3 style="margin-bottom: 15px; color: #2d3748;">Diff: ${filePath}</h3>
                <div class="diff-viewer">
                    <pre>${diffHtml}</pre>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error computing diff:', error);
        resultDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    }
}

// Format diff output with colors
function formatDiff(diffText) {
    return diffText.split('\n').map(line => {
        if (line.startsWith('+') && !line.startsWith('+++')) {
            return `<span class="diff-line-added">${escapeHtml(line)}</span>`;
        } else if (line.startsWith('-') && !line.startsWith('---')) {
            return `<span class="diff-line-removed">${escapeHtml(line)}</span>`;
        } else {
            return escapeHtml(line);
        }
    }).join('\n');
}

// Utility: Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize: Load current project file tree
loadFileTree();
</script>
{% endblock %}
