{% extends "base.html" %}

{% block title %}Run {{ run.run_id }} - AI Dev Team Dashboard{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/" style="color: #667eea; text-decoration: none;">â† Back to Dashboard</a>
</div>

<div class="card">
    <h2>Run Details: {{ run.run_id }}</h2>

    <div class="grid">
        <div class="stat-card">
            <div class="label">Status</div>
            <div class="value">
                {% if run.final_status in ['success', 'completed', 'approved'] %}
                    <span class="badge badge-success" style="font-size: 1.2rem; padding: 8px 16px;">{{ run.final_status }}</span>
                {% elif run.final_status in ['needs_changes', 'in_progress'] %}
                    <span class="badge badge-warning" style="font-size: 1.2rem; padding: 8px 16px;">{{ run.final_status }}</span>
                {% elif run.final_status in ['exception', 'safety_failed', 'timeout'] %}
                    <span class="badge badge-error" style="font-size: 1.2rem; padding: 8px 16px;">{{ run.final_status }}</span>
                {% else %}
                    <span class="badge badge-info" style="font-size: 1.2rem; padding: 8px 16px;">{{ run.final_status }}</span>
                {% endif %}
            </div>
        </div>
        <div class="stat-card">
            <div class="label">Rounds Completed</div>
            <div class="value">{{ run.rounds_completed }} / {{ run.max_rounds }}</div>
        </div>
        <div class="stat-card">
            <div class="label">Total Cost</div>
            <div class="value">${{ "%.4f"|format(run.cost_summary.total_usd if run.cost_summary else 0.0) }}</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>ğŸ“ Configuration</h2>
    <table style="width: 100%;">
        <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 10px; font-weight: 500; width: 200px;">Project</td>
            <td style="padding: 10px;">{{ run.project_dir.split('/')[-1] }}</td>
        </tr>
        <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 10px; font-weight: 500;">Mode</td>
            <td style="padding: 10px;">{{ run.mode }}</td>
        </tr>
        <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 10px; font-weight: 500;">Task</td>
            <td style="padding: 10px;">{{ run.task }}</td>
        </tr>
        <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 10px; font-weight: 500;">Started At</td>
            <td style="padding: 10px;">{{ run.started_at[:19].replace('T', ' ') }} UTC</td>
        </tr>
        {% if run.finished_at %}
        <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 10px; font-weight: 500;">Finished At</td>
            <td style="padding: 10px;">{{ run.finished_at[:19].replace('T', ' ') }} UTC</td>
        </tr>
        {% endif %}
        <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 10px; font-weight: 500;">Visual Review</td>
            <td style="padding: 10px;">{{ 'Enabled' if run.config.use_visual_review else 'Disabled' }}</td>
        </tr>
        <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 10px; font-weight: 500;">Git Integration</td>
            <td style="padding: 10px;">{{ 'Enabled' if run.config.use_git else 'Disabled' }}</td>
        </tr>
    </table>
</div>

{% if run.cost_summary %}
<div class="card">
    <h2>ğŸ’° Cost Breakdown</h2>

    {% if run.estimated_cost_usd %}
    <div style="margin-bottom: 15px;">
        <strong>Estimated Cost:</strong> ${{ "%.4f"|format(run.estimated_cost_usd) }}
    </div>
    {% endif %}

    <table class="table">
        <thead>
            <tr>
                <th>Model</th>
                <th>Input Tokens</th>
                <th>Output Tokens</th>
                <th>Cost</th>
            </tr>
        </thead>
        <tbody>
            {% for model, data in run.cost_summary.get('by_model', {}).items() %}
            <tr>
                <td>{{ model }}</td>
                <td>{{ "{:,}".format(data.input_tokens) }}</td>
                <td>{{ "{:,}".format(data.output_tokens) }}</td>
                <td>${{ "%.4f"|format(data.cost_usd) }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot style="font-weight: 600; background: #f7fafc;">
            <tr>
                <td>Total</td>
                <td>{{ "{:,}".format(run.cost_summary.total_input_tokens) }}</td>
                <td>{{ "{:,}".format(run.cost_summary.total_output_tokens) }}</td>
                <td>${{ "%.4f"|format(run.cost_summary.total_usd) }}</td>
            </tr>
        </tfoot>
    </table>
</div>
{% endif %}

{% if run.iterations %}
<div class="card">
    <h2>ğŸ”„ Iteration Log</h2>

    {% for iteration in run.iterations %}
    <div style="border-left: 3px solid #cbd5e0; padding-left: 20px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <strong>Iteration {{ iteration.index }}</strong> - {{ iteration.role }}
            </div>
            <div>
                {% if iteration.status in ['ok', 'approved'] %}
                    <span class="badge badge-success">{{ iteration.status }}</span>
                {% elif iteration.status in ['needs_changes'] %}
                    <span class="badge badge-warning">{{ iteration.status }}</span>
                {% elif iteration.status in ['safety_failed', 'timeout', 'exception'] %}
                    <span class="badge badge-error">{{ iteration.status }}</span>
                {% else %}
                    <span class="badge badge-info">{{ iteration.status }}</span>
                {% endif %}
            </div>
        </div>
        <div style="color: #718096; font-size: 0.9rem; margin-bottom: 5px;">
            {{ iteration.timestamp[:19].replace('T', ' ') if iteration.timestamp else 'N/A' }}
        </div>
        <div style="background: #f7fafc; padding: 12px; border-radius: 6px; font-size: 0.95rem;">
            {{ iteration.notes }}
        </div>
        {% if iteration.safety_status %}
        <div style="margin-top: 8px;">
            <strong>Safety:</strong>
            {% if iteration.safety_status == 'passed' %}
                <span class="badge badge-success">{{ iteration.safety_status }}</span>
            {% else %}
                <span class="badge badge-error">{{ iteration.safety_status }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <h2>ğŸ”„ Iteration Log</h2>
    <div class="empty-state">
        <p>No iteration logs available</p>
    </div>
</div>
{% endif %}

<div class="card">
    <h2>ğŸ“¦ Raw Data</h2>
    <details>
        <summary style="cursor: pointer; padding: 10px; background: #f7fafc; border-radius: 6px; margin-bottom: 10px;">
            Click to view raw JSON
        </summary>
        <pre style="background: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 6px; overflow-x: auto; font-size: 0.85rem;">{{ run | tojson(indent=2) }}</pre>
    </details>
</div>
{% endblock %}
