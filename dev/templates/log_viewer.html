<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchestrator Log Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            display: flex;
            height: 100vh;
            background: #f5f5f5;
        }

        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            overflow-y: auto;
            padding: 1rem;
        }

        .sidebar h2 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .run-list {
            list-style: none;
        }

        .run-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #34495e;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .run-item:hover {
            background: #415a77;
        }

        .run-item.active {
            background: #3498db;
        }

        .run-id {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .run-meta {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 2px solid #ecf0f1;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .summary-section {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-section h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: bold;
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .info-value {
            color: #2c3e50;
            font-size: 1rem;
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .status-success {
            background: #27ae60;
            color: white;
        }

        .status-failed {
            background: #e74c3c;
            color: white;
        }

        .status-partial {
            background: #f39c12;
            color: white;
        }

        .status-unknown {
            background: #95a5a6;
            color: white;
        }

        .iterations-list {
            list-style: none;
        }

        .iteration-item {
            background: #ecf0f1;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .iteration-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .iteration-notes {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        code {
            background: #ecf0f1;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin-top: 0.5rem;
        }

        .no-selection {
            text-align: center;
            padding: 4rem 2rem;
            color: #95a5a6;
        }

        .session-runs {
            list-style: none;
        }

        .session-run-item {
            background: #f8f9fa;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            border-left: 4px solid #9b59b6;
        }

        .session-run-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .score-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #3498db;
            color: white;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>üìä Run Logs</h2>
        <ul class="run-list" id="run-list">
            <!-- Will be populated by JavaScript -->
        </ul>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Orchestrator Log Viewer</h1>
        </div>
        <div class="content" id="content">
            <div class="no-selection">
                <h2>Select a run from the sidebar</h2>
                <p>Click on a run ID to view its details</p>
            </div>
        </div>
    </div>

    <script>
        // Log data injected by Python script
        const LOG_DATA = {{LOG_DATA_PLACEHOLDER}};

        // Populate run list
        function populateRunList() {
            const runList = document.getElementById('run-list');
            runList.innerHTML = '';

            LOG_DATA.forEach((log, index) => {
                const li = document.createElement('li');
                li.className = 'run-item';
                li.dataset.index = index;

                const runType = log.session_id ? 'üîÑ Session' : '‚ñ∂Ô∏è Run';
                const runId = log.session_id || log.run_id;
                const status = log.final_decision || log.final_status || 'unknown';
                const timestamp = new Date(log.started_at).toLocaleString();

                li.innerHTML = `
                    <div class="run-id">${runType} ${runId.substring(0, 12)}</div>
                    <div class="run-meta">${status} ‚Ä¢ ${timestamp}</div>
                `;

                li.addEventListener('click', () => showLog(index));
                runList.appendChild(li);
            });

            // Show first log by default
            if (LOG_DATA.length > 0) {
                showLog(0);
            }
        }

        // Show log details
        function showLog(index) {
            const log = LOG_DATA[index];
            const content = document.getElementById('content');

            // Update active state
            document.querySelectorAll('.run-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });

            // Check if it's a session or run
            if (log.session_id) {
                content.innerHTML = renderSession(log);
            } else {
                content.innerHTML = renderRun(log);
            }
        }

        // Render run summary
        function renderRun(log) {
            const statusClass = getStatusClass(log.final_status);

            return `
                <div class="summary-section">
                    <h2>üìù Run Summary</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Run ID</div>
                            <div class="info-value"><code>${log.run_id}</code></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Final Status</div>
                            <div class="info-value"><span class="status status-${statusClass}">${log.final_status}</span></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Mode</div>
                            <div class="info-value">${log.mode}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Rounds</div>
                            <div class="info-value">${log.rounds_completed} / ${log.max_rounds}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Safety Status</div>
                            <div class="info-value">${log.safety_status || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total Cost</div>
                            <div class="info-value">$${(log.cost_summary?.total_usd || 0).toFixed(4)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Started At</div>
                            <div class="info-value">${new Date(log.started_at).toLocaleString()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Duration</div>
                            <div class="info-value">${calculateDuration(log.started_at, log.finished_at)}</div>
                        </div>
                    </div>
                </div>

                ${log.task ? `
                <div class="summary-section">
                    <h2>üìã Task</h2>
                    <p>${escapeHtml(log.task)}</p>
                </div>
                ` : ''}

                ${log.iterations && log.iterations.length > 0 ? `
                <div class="summary-section">
                    <h2>üîÑ Iterations (${log.iterations.length})</h2>
                    <ul class="iterations-list">
                        ${log.iterations.map(iter => `
                            <li class="iteration-item">
                                <div class="iteration-header">
                                    <span>Iteration ${iter.index} - ${iter.role}</span>
                                    <span><span class="status status-${getStatusClass(iter.status)}">${iter.status}</span></span>
                                </div>
                                <div class="iteration-notes">${escapeHtml(iter.notes || 'No notes')}</div>
                                ${iter.safety_status ? `<div class="iteration-notes">Safety: ${iter.safety_status}</div>` : ''}
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}

                ${log.cost_summary ? `
                <div class="summary-section">
                    <h2>üí∞ Cost Breakdown</h2>
                    <pre>${JSON.stringify(log.cost_summary, null, 2)}</pre>
                </div>
                ` : ''}
            `;
        }

        // Render session summary
        function renderSession(log) {
            const statusClass = getStatusClass(log.final_decision);

            return `
                <div class="summary-section">
                    <h2>üîÑ Session Summary</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Session ID</div>
                            <div class="info-value"><code>${log.session_id}</code></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Final Decision</div>
                            <div class="info-value"><span class="status status-${statusClass}">${log.final_decision}</span></div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Sub-Runs</div>
                            <div class="info-value">${log.runs?.length || 0} / ${log.max_sub_runs}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total Cost</div>
                            <div class="info-value">$${(log.total_cost_usd || 0).toFixed(4)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Started At</div>
                            <div class="info-value">${new Date(log.started_at).toLocaleString()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Duration</div>
                            <div class="info-value">${calculateDuration(log.started_at, log.finished_at)}</div>
                        </div>
                    </div>
                </div>

                ${log.task ? `
                <div class="summary-section">
                    <h2>üìã Task</h2>
                    <p>${escapeHtml(log.task)}</p>
                </div>
                ` : ''}

                ${log.runs && log.runs.length > 0 ? `
                <div class="summary-section">
                    <h2>üìä Sub-Runs (${log.runs.length})</h2>
                    <ul class="session-runs">
                        ${log.runs.map((run, i) => {
                            const eval_result = run.evaluation || {};
                            return `
                                <li class="session-run-item">
                                    <div class="session-run-header">
                                        Run ${i + 1}: ${run.run_id?.substring(0, 12) || 'unknown'}
                                        <span class="score-badge">Score: ${(eval_result.overall_score || 0).toFixed(3)}</span>
                                        <span class="status status-${getStatusClass(run.final_status)}">${run.final_status}</span>
                                    </div>
                                    <div style="margin-top: 0.5rem;">
                                        <strong>Recommendation:</strong> ${eval_result.recommendation || 'N/A'}<br>
                                        <strong>Quality:</strong> ${(eval_result.score_quality || 0).toFixed(3)} |
                                        <strong>Safety:</strong> ${(eval_result.score_safety || 0).toFixed(3)} |
                                        <strong>Cost:</strong> ${(eval_result.score_cost || 0).toFixed(3)}<br>
                                        <strong>Cost:</strong> $${(run.cost_usd || 0).toFixed(4)}<br>
                                        ${eval_result.reasoning ? `<strong>Reasoning:</strong> ${escapeHtml(eval_result.reasoning)}` : ''}
                                    </div>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                </div>
                ` : ''}
            `;
        }

        // Helper functions
        function getStatusClass(status) {
            if (!status) return 'unknown';
            const s = status.toLowerCase();
            if (s.includes('success') || s.includes('completed') || s.includes('passed') || s.includes('approved')) {
                return 'success';
            } else if (s.includes('failed') || s.includes('error') || s.includes('exception')) {
                return 'failed';
            } else if (s.includes('partial') || s.includes('warning') || s.includes('max_rounds')) {
                return 'partial';
            }
            return 'unknown';
        }

        function calculateDuration(start, end) {
            if (!start || !end) return 'N/A';
            const diff = new Date(end) - new Date(start);
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        populateRunList();
    </script>
</body>
</html>
